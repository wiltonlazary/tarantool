-- optimize one index
space = box.schema.space.create('test', { engine = 'vinyl' })
---
...
index = space:create_index('primary')
---
...
index2 = space:create_index('secondary', { parts = {5, 'unsigned'} })
---
...
old_count = box.info.vinyl().performance.write_count
---
...
space:insert({1, 2, 3, 4, 5})
---
- [1, 2, 3, 4, 5]
...
space:insert({2, 3, 4, 5, 6})
---
- [2, 3, 4, 5, 6]
...
space:insert({3, 4, 5, 6, 7})
---
- [3, 4, 5, 6, 7]
...
space:insert({4, 5, 6, 7, 8})
---
- [4, 5, 6, 7, 8]
...
new_count = box.info.vinyl().performance.write_count
---
...
new_count - old_count == 8
---
- true
...
old_count = new_count
---
...
-- not optimized updates
space:update({1}, {{'=', 5, 10}}) -- change secondary index field
---
- [1, 2, 3, 4, 10]
...
space:update({1}, {{'!', 4, 20}}) -- move range containing index field
---
- [1, 2, 3, 20, 4, 10]
...
space:update({1}, {{'#', 3, 1}}) -- same
---
- [1, 2, 20, 4, 10]
...
new_count = box.info.vinyl().performance.write_count
---
...
new_count - old_count == 9
---
- true
...
old_count = new_count
---
...
space:select{}
---
- - [1, 2, 20, 4, 10]
  - [2, 3, 4, 5, 6]
  - [3, 4, 5, 6, 7]
  - [4, 5, 6, 7, 8]
...
index2:select{}
---
- - [2, 3, 4, 5, 6]
  - [3, 4, 5, 6, 7]
  - [4, 5, 6, 7, 8]
  - [1, 2, 20, 4, 10]
...
-- optimized updates
space:update({2}, {{'=', 6, 10}}) -- change not indexed field
---
- [2, 3, 4, 5, 6, 10]
...
space:update({2}, {{'!', 7, 20}}) -- move range that doesn't contain 
---
- [2, 3, 4, 5, 6, 10, 20]
...
space:update({2}, {{'#', 6, 1}}) -- same
---
- [2, 3, 4, 5, 6, 20]
...
new_count = box.info.vinyl().performance.write_count
---
...
new_count - old_count == 3
---
- true
...
old_count = new_count
---
...
space:select{}
---
- - [1, 2, 20, 4, 10]
  - [2, 3, 4, 5, 6, 20]
  - [3, 4, 5, 6, 7]
  - [4, 5, 6, 7, 8]
...
index2:select{}
---
- - [2, 3, 4, 5, 6, 20]
  - [3, 4, 5, 6, 7]
  - [4, 5, 6, 7, 8]
  - [1, 2, 20, 4, 10]
...
space:drop()
---
...
-- optimize two indexes
space = box.schema.space.create('test', { engine = 'vinyl' })
---
...
index = space:create_index('primary', { parts = {2, 'unsigned'} } )
---
...
index2 = space:create_index('secondary', { parts = {4, 'unsigned', 3, 'unsigned'} })
---
...
index3 = space:create_index('third', { parts = {5, 'unsigned'} })
---
...
old_count = box.info.vinyl().performance.write_count
---
...
space:insert({1, 2, 3, 4, 5})
---
- [1, 2, 3, 4, 5]
...
space:insert({2, 3, 4, 5, 6})
---
- [2, 3, 4, 5, 6]
...
space:insert({3, 4, 5, 6, 7})
---
- [3, 4, 5, 6, 7]
...
space:insert({4, 5, 6, 7, 8})
---
- [4, 5, 6, 7, 8]
...
new_count = box.info.vinyl().performance.write_count
---
...
new_count - old_count == 12
---
- true
...
old_count = new_count
---
...
-- not optimizes updates
index:update({2}, {{'+', 1, 10}, {'+', 3, 10}, {'+', 4, 10}, {'+', 5, 10}}) -- change all fields
---
- [11, 2, 13, 14, 15]
...
index:update({2}, {{'!', 3, 20}}) -- move range containing all indexes
---
- [11, 2, 20, 13, 14, 15]
...
index:update({2}, {{'=', 7, 100}, {'+', 5, 10}, {'#', 3, 1}}) -- change two cols but then move range with all indexed fields
---
- [11, 2, 13, 24, 15, 100]
...
new_count = box.info.vinyl().performance.write_count
---
...
new_count - old_count == 15
---
- true
...
old_count = new_count
---
...
space:select{}
---
- - [11, 2, 13, 24, 15, 100]
  - [2, 3, 4, 5, 6]
  - [3, 4, 5, 6, 7]
  - [4, 5, 6, 7, 8]
...
index2:select{}
---
- - [2, 3, 4, 5, 6]
  - [3, 4, 5, 6, 7]
  - [4, 5, 6, 7, 8]
  - [11, 2, 13, 24, 15, 100]
...
index3:select{}
---
- - [2, 3, 4, 5, 6]
  - [3, 4, 5, 6, 7]
  - [4, 5, 6, 7, 8]
  - [11, 2, 13, 24, 15, 100]
...
-- optimize one 'secondary' index update
index:update({3}, {{'+', 1, 10}, {'-', 5, 2}, {'!', 6, 100}}) -- change only index 'third'
---
- [12, 3, 4, 5, 4, 100]
...
new_count = box.info.vinyl().performance.write_count
---
...
new_count - old_count == 3
---
- true
...
old_count = new_count
---
...
-- optimize one 'third' index update
index:update({3}, {{'=', 1, 20}, {'+', 3, 5}, {'=', 4, 30}, {'!', 6, 110}}) -- change only index 'secondary'
---
- [20, 3, 9, 30, 4, 110, 100]
...
new_count = box.info.vinyl().performance.write_count
---
...
new_count - old_count == 3
---
- true
...
old_count = new_count
---
...
-- optimize both indexes
index:update({3}, {{'+', 1, 10}, {'#', 6, 1}}) -- don't change any indexed fields
---
- [30, 3, 9, 30, 4, 100]
...
new_count = box.info.vinyl().performance.write_count
---
...
new_count - old_count == 1
---
- true
...
old_count = new_count
---
...
space:select{}
---
- - [11, 2, 13, 24, 15, 100]
  - [30, 3, 9, 30, 4, 100]
  - [3, 4, 5, 6, 7]
  - [4, 5, 6, 7, 8]
...
index2:select{}
---
- - [3, 4, 5, 6, 7]
  - [4, 5, 6, 7, 8]
  - [11, 2, 13, 24, 15, 100]
  - [30, 3, 9, 30, 4, 100]
...
index3:select{}
---
- - [30, 3, 9, 30, 4, 100]
  - [3, 4, 5, 6, 7]
  - [4, 5, 6, 7, 8]
  - [11, 2, 13, 24, 15, 100]
...
space:drop()
---
...
