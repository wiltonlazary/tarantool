test_run = require('test_run')
---
...
inspector = test_run.new()
---
...
engine = inspector:get_cfg('engine')
---
...
-- update (str)
space = box.schema.space.create('test', { engine = engine })
---
...
index = space:create_index('primary', { type = 'tree', parts = {1, 'str'} })
---
...
for key = 1, 100 do space:replace({tostring(key)}) end
---
...
for key = 1, 100 do space:update({tostring(key)}, {{'=', 2, key}}) end
---
...
t = {}
---
...
for key = 1, 100 do table.insert(t, space:get({tostring(key)})) end
---
...
t
---
- - ['1', 1]
  - ['2', 2]
  - ['3', 3]
  - ['4', 4]
  - ['5', 5]
  - ['6', 6]
  - ['7', 7]
  - ['8', 8]
  - ['9', 9]
  - ['10', 10]
  - ['11', 11]
  - ['12', 12]
  - ['13', 13]
  - ['14', 14]
  - ['15', 15]
  - ['16', 16]
  - ['17', 17]
  - ['18', 18]
  - ['19', 19]
  - ['20', 20]
  - ['21', 21]
  - ['22', 22]
  - ['23', 23]
  - ['24', 24]
  - ['25', 25]
  - ['26', 26]
  - ['27', 27]
  - ['28', 28]
  - ['29', 29]
  - ['30', 30]
  - ['31', 31]
  - ['32', 32]
  - ['33', 33]
  - ['34', 34]
  - ['35', 35]
  - ['36', 36]
  - ['37', 37]
  - ['38', 38]
  - ['39', 39]
  - ['40', 40]
  - ['41', 41]
  - ['42', 42]
  - ['43', 43]
  - ['44', 44]
  - ['45', 45]
  - ['46', 46]
  - ['47', 47]
  - ['48', 48]
  - ['49', 49]
  - ['50', 50]
  - ['51', 51]
  - ['52', 52]
  - ['53', 53]
  - ['54', 54]
  - ['55', 55]
  - ['56', 56]
  - ['57', 57]
  - ['58', 58]
  - ['59', 59]
  - ['60', 60]
  - ['61', 61]
  - ['62', 62]
  - ['63', 63]
  - ['64', 64]
  - ['65', 65]
  - ['66', 66]
  - ['67', 67]
  - ['68', 68]
  - ['69', 69]
  - ['70', 70]
  - ['71', 71]
  - ['72', 72]
  - ['73', 73]
  - ['74', 74]
  - ['75', 75]
  - ['76', 76]
  - ['77', 77]
  - ['78', 78]
  - ['79', 79]
  - ['80', 80]
  - ['81', 81]
  - ['82', 82]
  - ['83', 83]
  - ['84', 84]
  - ['85', 85]
  - ['86', 86]
  - ['87', 87]
  - ['88', 88]
  - ['89', 89]
  - ['90', 90]
  - ['91', 91]
  - ['92', 92]
  - ['93', 93]
  - ['94', 94]
  - ['95', 95]
  - ['96', 96]
  - ['97', 97]
  - ['98', 98]
  - ['99', 99]
  - ['100', 100]
...
space:update({tostring(101)}, {{'=', 2, 101}})
---
...
space:get({tostring(101)})
---
...
space:drop()
---
...
-- update (num)
space = box.schema.space.create('test', { engine = engine })
---
...
index = space:create_index('primary', { type = 'tree', parts = {1, 'num'} })
---
...
for key = 1, 100 do space:replace({key}) end
---
...
for key = 1, 100 do space:update({key}, {{'=', 2, key}}) end
---
...
t = {}
---
...
for key = 1, 100 do table.insert(t, space:get({key})) end
---
...
t
---
- - [1, 1]
  - [2, 2]
  - [3, 3]
  - [4, 4]
  - [5, 5]
  - [6, 6]
  - [7, 7]
  - [8, 8]
  - [9, 9]
  - [10, 10]
  - [11, 11]
  - [12, 12]
  - [13, 13]
  - [14, 14]
  - [15, 15]
  - [16, 16]
  - [17, 17]
  - [18, 18]
  - [19, 19]
  - [20, 20]
  - [21, 21]
  - [22, 22]
  - [23, 23]
  - [24, 24]
  - [25, 25]
  - [26, 26]
  - [27, 27]
  - [28, 28]
  - [29, 29]
  - [30, 30]
  - [31, 31]
  - [32, 32]
  - [33, 33]
  - [34, 34]
  - [35, 35]
  - [36, 36]
  - [37, 37]
  - [38, 38]
  - [39, 39]
  - [40, 40]
  - [41, 41]
  - [42, 42]
  - [43, 43]
  - [44, 44]
  - [45, 45]
  - [46, 46]
  - [47, 47]
  - [48, 48]
  - [49, 49]
  - [50, 50]
  - [51, 51]
  - [52, 52]
  - [53, 53]
  - [54, 54]
  - [55, 55]
  - [56, 56]
  - [57, 57]
  - [58, 58]
  - [59, 59]
  - [60, 60]
  - [61, 61]
  - [62, 62]
  - [63, 63]
  - [64, 64]
  - [65, 65]
  - [66, 66]
  - [67, 67]
  - [68, 68]
  - [69, 69]
  - [70, 70]
  - [71, 71]
  - [72, 72]
  - [73, 73]
  - [74, 74]
  - [75, 75]
  - [76, 76]
  - [77, 77]
  - [78, 78]
  - [79, 79]
  - [80, 80]
  - [81, 81]
  - [82, 82]
  - [83, 83]
  - [84, 84]
  - [85, 85]
  - [86, 86]
  - [87, 87]
  - [88, 88]
  - [89, 89]
  - [90, 90]
  - [91, 91]
  - [92, 92]
  - [93, 93]
  - [94, 94]
  - [95, 95]
  - [96, 96]
  - [97, 97]
  - [98, 98]
  - [99, 99]
  - [100, 100]
...
space:update({101}, {{'=', 2, 101}})
---
...
space:get({101})
---
...
space:drop()
---
...
-- update multi-part (num, num)
space = box.schema.space.create('test', { engine = engine })
---
...
index = space:create_index('primary', { type = 'tree', parts = {1, 'num', 2, 'num'} })
---
...
for key = 1, 100 do space:replace({key, key}) end
---
...
for key = 1, 100 do space:update({key, key}, {{'=', 3, key}}) end
---
...
t = {}
---
...
for key = 1, 100 do table.insert(t, space:get({key, key})) end
---
...
t
---
- - [1, 1, 1]
  - [2, 2, 2]
  - [3, 3, 3]
  - [4, 4, 4]
  - [5, 5, 5]
  - [6, 6, 6]
  - [7, 7, 7]
  - [8, 8, 8]
  - [9, 9, 9]
  - [10, 10, 10]
  - [11, 11, 11]
  - [12, 12, 12]
  - [13, 13, 13]
  - [14, 14, 14]
  - [15, 15, 15]
  - [16, 16, 16]
  - [17, 17, 17]
  - [18, 18, 18]
  - [19, 19, 19]
  - [20, 20, 20]
  - [21, 21, 21]
  - [22, 22, 22]
  - [23, 23, 23]
  - [24, 24, 24]
  - [25, 25, 25]
  - [26, 26, 26]
  - [27, 27, 27]
  - [28, 28, 28]
  - [29, 29, 29]
  - [30, 30, 30]
  - [31, 31, 31]
  - [32, 32, 32]
  - [33, 33, 33]
  - [34, 34, 34]
  - [35, 35, 35]
  - [36, 36, 36]
  - [37, 37, 37]
  - [38, 38, 38]
  - [39, 39, 39]
  - [40, 40, 40]
  - [41, 41, 41]
  - [42, 42, 42]
  - [43, 43, 43]
  - [44, 44, 44]
  - [45, 45, 45]
  - [46, 46, 46]
  - [47, 47, 47]
  - [48, 48, 48]
  - [49, 49, 49]
  - [50, 50, 50]
  - [51, 51, 51]
  - [52, 52, 52]
  - [53, 53, 53]
  - [54, 54, 54]
  - [55, 55, 55]
  - [56, 56, 56]
  - [57, 57, 57]
  - [58, 58, 58]
  - [59, 59, 59]
  - [60, 60, 60]
  - [61, 61, 61]
  - [62, 62, 62]
  - [63, 63, 63]
  - [64, 64, 64]
  - [65, 65, 65]
  - [66, 66, 66]
  - [67, 67, 67]
  - [68, 68, 68]
  - [69, 69, 69]
  - [70, 70, 70]
  - [71, 71, 71]
  - [72, 72, 72]
  - [73, 73, 73]
  - [74, 74, 74]
  - [75, 75, 75]
  - [76, 76, 76]
  - [77, 77, 77]
  - [78, 78, 78]
  - [79, 79, 79]
  - [80, 80, 80]
  - [81, 81, 81]
  - [82, 82, 82]
  - [83, 83, 83]
  - [84, 84, 84]
  - [85, 85, 85]
  - [86, 86, 86]
  - [87, 87, 87]
  - [88, 88, 88]
  - [89, 89, 89]
  - [90, 90, 90]
  - [91, 91, 91]
  - [92, 92, 92]
  - [93, 93, 93]
  - [94, 94, 94]
  - [95, 95, 95]
  - [96, 96, 96]
  - [97, 97, 97]
  - [98, 98, 98]
  - [99, 99, 99]
  - [100, 100, 100]
...
space:update({101, 101}, {{'=', 3, 101}})
---
...
space:get({101, 101})
---
...
space:drop()
---
...
-- update with box.tuple.new
space = box.schema.space.create('test', { engine = engine })
---
...
index = space:create_index('primary', { type = 'tree', parts = {1, 'num', 2, 'num'} })
---
...
for key = 1, 100 do space:replace({key, key}) end
---
...
for key = 1, 100 do space:update(box.tuple.new{key, key}, box.tuple.new{{'=', 3, key}}) end
---
...
t = {}
---
...
for key = 1, 100 do table.insert(t, space:get({key, key})) end
---
...
t
---
- - [1, 1, 1]
  - [2, 2, 2]
  - [3, 3, 3]
  - [4, 4, 4]
  - [5, 5, 5]
  - [6, 6, 6]
  - [7, 7, 7]
  - [8, 8, 8]
  - [9, 9, 9]
  - [10, 10, 10]
  - [11, 11, 11]
  - [12, 12, 12]
  - [13, 13, 13]
  - [14, 14, 14]
  - [15, 15, 15]
  - [16, 16, 16]
  - [17, 17, 17]
  - [18, 18, 18]
  - [19, 19, 19]
  - [20, 20, 20]
  - [21, 21, 21]
  - [22, 22, 22]
  - [23, 23, 23]
  - [24, 24, 24]
  - [25, 25, 25]
  - [26, 26, 26]
  - [27, 27, 27]
  - [28, 28, 28]
  - [29, 29, 29]
  - [30, 30, 30]
  - [31, 31, 31]
  - [32, 32, 32]
  - [33, 33, 33]
  - [34, 34, 34]
  - [35, 35, 35]
  - [36, 36, 36]
  - [37, 37, 37]
  - [38, 38, 38]
  - [39, 39, 39]
  - [40, 40, 40]
  - [41, 41, 41]
  - [42, 42, 42]
  - [43, 43, 43]
  - [44, 44, 44]
  - [45, 45, 45]
  - [46, 46, 46]
  - [47, 47, 47]
  - [48, 48, 48]
  - [49, 49, 49]
  - [50, 50, 50]
  - [51, 51, 51]
  - [52, 52, 52]
  - [53, 53, 53]
  - [54, 54, 54]
  - [55, 55, 55]
  - [56, 56, 56]
  - [57, 57, 57]
  - [58, 58, 58]
  - [59, 59, 59]
  - [60, 60, 60]
  - [61, 61, 61]
  - [62, 62, 62]
  - [63, 63, 63]
  - [64, 64, 64]
  - [65, 65, 65]
  - [66, 66, 66]
  - [67, 67, 67]
  - [68, 68, 68]
  - [69, 69, 69]
  - [70, 70, 70]
  - [71, 71, 71]
  - [72, 72, 72]
  - [73, 73, 73]
  - [74, 74, 74]
  - [75, 75, 75]
  - [76, 76, 76]
  - [77, 77, 77]
  - [78, 78, 78]
  - [79, 79, 79]
  - [80, 80, 80]
  - [81, 81, 81]
  - [82, 82, 82]
  - [83, 83, 83]
  - [84, 84, 84]
  - [85, 85, 85]
  - [86, 86, 86]
  - [87, 87, 87]
  - [88, 88, 88]
  - [89, 89, 89]
  - [90, 90, 90]
  - [91, 91, 91]
  - [92, 92, 92]
  - [93, 93, 93]
  - [94, 94, 94]
  - [95, 95, 95]
  - [96, 96, 96]
  - [97, 97, 97]
  - [98, 98, 98]
  - [99, 99, 99]
  - [100, 100, 100]
...
space:update({101, 101}, {{'=', 3, 101}})
---
...
space:get({101, 101})
---
...
space:drop()
---
...
-- update multiple indices
space = box.schema.space.create('test', { engine = engine })
---
...
index1 = space:create_index('primary', { type = 'tree', parts = {1, 'num', 2, 'str'} })
---
...
index2 = space:create_index('secondary', { type = 'tree', parts = {2, 'str'}, unique = false })
---
...
index3 = space:create_index('third', { type = 'tree', parts = {3, 'scalar', 2, 'str', 1, 'num'}, unique = false })
---
...
space:insert({1, 'fwoen', 324})
---
- [1, 'fwoen', 324]
...
space:insert({2, 'fwoen', 123})
---
- [2, 'fwoen', 123]
...
space:insert({3, 'fwoen', 324})
---
- [3, 'fwoen', 324]
...
space:insert({4, '21qn2', 213})
---
- [4, '21qn2', 213]
...
space:insert({5, 'fgb', '231293'})
---
- [5, 'fgb', '231293']
...
space:insert({6, 'nrhjrt', -1231.234})
---
- [6, 'nrhjrt', -1231.234]
...
index1:update({1}, {{'+', 3, 10}})
---
- error: Invalid key part count in an exact match (expected 2, got 1)
...
index1:update({1, 'fwoen'}, {{'+', 3, 10}})
---
- [1, 'fwoen', 334]
...
index1:update({0, 'fwoen'}, {{'=', 3, 5}})
---
...
index2:update({'fwoen'}, {'=', 3, 1000})
---
- error: More than one tuple found by get()
...
index3:update({324, 'fwoen', 3}, {{'-', 3, 100}})
---
- error: More than one tuple found by get()
...
space:drop()
---
...
